<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>D·ª± ƒëo√°n Ti·ªÉu ƒë∆∞·ªùng</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <h1>üî¨ H·ªá th·ªëng d·ª± ƒëo√°n Ti·ªÉu ƒë∆∞·ªùng</h1>

  <form method="POST">
    <div class="form-group">
      <label for="gender">Gi·ªõi t√≠nh <span class="info" title="Gi·ªõi t√≠nh c·ªßa b·ªánh nh√¢n (Nam, N·ªØ ho·∫∑c Kh√°c).">‚ÑπÔ∏è</span></label>
      <select name="gender" required>
        <option value="Male">Nam</option>
        <option value="Female">N·ªØ</option>
        <option value="Other">Kh√°c</option>
      </select>
    </div>

    <div class="form-group">
      <label for="age">Tu·ªïi <span class="info" title="Tu·ªïi ·∫£nh h∆∞·ªüng ƒë·∫øn nguy c∆° m·∫Øc b·ªánh ti·ªÉu ƒë∆∞·ªùng.">‚ÑπÔ∏è</span></label>
      <input type="number" name="age" min="0" max="120" required>
    </div>

    <div class="form-group">
      <label for="hypertension">Cao huy·∫øt √°p <span class="info" title="Ng∆∞·ªùi b·ªã cao huy·∫øt √°p c√≥ nguy c∆° cao h∆°n m·∫Øc ti·ªÉu ƒë∆∞·ªùng.">‚ÑπÔ∏è</span></label>
      <select name="hypertension" required>
        <option value="0">Kh√¥ng</option>
        <option value="1">C√≥</option>
      </select>
    </div>

    <div class="form-group">
      <label for="heart_disease">B·ªánh tim <span class="info" title="Ti·ªÉu ƒë∆∞·ªùng th∆∞·ªùng ƒëi k√®m v·ªõi c√°c b·ªánh tim m·∫°ch.">‚ÑπÔ∏è</span></label>
      <select name="heart_disease" required>
        <option value="0">Kh√¥ng</option>
        <option value="1">C√≥</option>
      </select>
    </div>

    <div class="form-group">
      <label for="smoking_history">H√∫t thu·ªëc <span class="info" title="H√∫t thu·ªëc l√†m tƒÉng nguy c∆° m·∫Øc nhi·ªÅu b·ªánh, bao g·ªìm ti·ªÉu ƒë∆∞·ªùng.">‚ÑπÔ∏è</span></label>
      <select name="smoking_history" required>
        <option value="never">Kh√¥ng h√∫t</option>
        <option value="former">ƒê√£ t·ª´ng</option>
        <option value="current">ƒêang h√∫t</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="bmi">Ch·ªâ s·ªë BMI <span class="info" title="BMI cho bi·∫øt m·ª©c ƒë·ªô g·∫ßy, b√¨nh th∆∞·ªùng hay th·ª´a c√¢n/d∆∞ c√¢n.">‚ÑπÔ∏è</span></label>
      <input type="number" step="0.1" name="bmi" required>
    </div>

    <div class="form-group">
      <label for="HbA1c_level">HbA1c Level <span class="info" title="Ph·∫£n √°nh m·ª©c ƒë∆∞·ªùng huy·∫øt trung b√¨nh trong 2‚Äì3 th√°ng.">‚ÑπÔ∏è</span></label>
      <input type="number" step="0.1" name="HbA1c_level" required>
    </div>

    <div class="form-group">
      <label for="blood_glucose_level">ƒê∆∞·ªùng huy·∫øt <span class="info" title="Glucose trong m√°u t·∫°i th·ªùi ƒëi·ªÉm hi·ªán t·∫°i.">‚ÑπÔ∏è</span></label>
      <input type="number" step="0.1" name="blood_glucose_level" required>
    </div>

    <button type="submit">D·ª± ƒëo√°n</button>
  </form>

  {% if results %}
  <div class="results">
    <h2>üìä K·∫øt qu·∫£ d·ª± ƒëo√°n</h2>
    <table class="fixed">
      <tr>
        <th>M√¥ h√¨nh</th>
        <th>D·ª± ƒëo√°n</th>
        <th>X√°c su·∫•t m·∫Øc b·ªánh</th>
      </tr>
      {% for model, (pred, prob) in results.items() %}
      <tr>
        <td>{{ model }}</td>
        <td>
          {% if pred==1 %}
            <span class="badge warn">C√≥</span>
          {% else %}
            <span class="badge ok">Kh√¥ng</span>
          {% endif %}
        </td>
        <td>{{ "%.2f"|format(prob*100) }}%</td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endif %}

  <div class="charts">
    <h2>üìà So s√°nh m√¥ h√¨nh</h2>
    <img src="{{ url_for('accuracy_chart') }}" alt="Bi·ªÉu ƒë·ªì ƒë·ªô ch√≠nh x√°c">
    <img src="{{ url_for('chart') }}" alt="Bi·ªÉu ƒë·ªì x√°c su·∫•t">
    
    <h3>üîé Ch·ªâ s·ªë ƒë√°nh gi√° m√¥ h√¨nh</h3>
    <div class="scroll-x">
      <table class="fixed">
        <tr>
          <th>M√¥ h√¨nh</th>
          <th>Accuracy</th>
          <th>MAE</th>
          <th>MSE</th>
          <th>R¬≤</th>
        </tr>
        {% for model, vals in metrics.items() %}
        <tr>
          <td>{{ model }}</td>
          <td>{{ "%.2f"|format(vals["ACC"]*100) }}%</td>
          <td>{{ "%.4f"|format(vals["MAE"]) }}</td>
          <td>{{ "%.4f"|format(vals["MSE"]) }}</td>
          <td>{{ "%.4f"|format(vals["R2"]) }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  {% if trace %}
  <div class="steps">
    <h2>üß≠ Quy tr√¨nh x·ª≠ l√Ω d·ªØ li·ªáu (t·ª´ng b∆∞·ªõc)</h2>

    <details open>
      <summary>1) D·ªØ li·ªáu g·ªëc t·ª´ Form</summary>
      <div class="kv">
        <div>Gi·ªõi t√≠nh</div><div class="mono">{{ trace.raw.gender }}</div>
        <div>Tu·ªïi</div><div class="mono">{{ trace.raw.age }}</div>
        <div>Cao huy·∫øt √°p</div><div class="mono">{{ trace.raw.hypertension }}</div>
        <div>B·ªánh tim</div><div class="mono">{{ trace.raw.heart_disease }}</div>
        <div>L·ªãch s·ª≠ h√∫t thu·ªëc</div><div class="mono">{{ trace.raw.smoking_history }}</div>
        <div>BMI</div><div class="mono">{{ trace.raw.bmi }}</div>
        <div>HbA1c</div><div class="mono">{{ trace.raw.HbA1c_level }}</div>
        <div>ƒê∆∞·ªùng huy·∫øt</div><div class="mono">{{ trace.raw.blood_glucose_level }}</div>
      </div>
    </details>

    <details open>
      <summary>2) M√£ ho√° bi·∫øn ph√¢n lo·∫°i (LabelEncoder)</summary>
      <div class="small">B·∫£ng √°nh x·∫°: gi√° tr·ªã g·ªëc ‚Üí m√£ s·ªë ƒë√£ h·ªçc</div>
      <div class="scroll-x">
        <table class="fixed">
          <tr><th>Thu·ªôc t√≠nh</th><th>Gi√° tr·ªã g·ªëc</th><th>M√£</th></tr>
          {% for k, v in trace.encoders.gender.items() %}
          <tr><td>gender</td><td class="mono">{{ k }}</td><td class="mono">{{ v }}</td></tr>
          {% endfor %}
          {% for k, v in trace.encoders.smoking_history.items() %}
          <tr><td>smoking_history</td><td class="mono">{{ k }}</td><td class="mono">{{ v }}</td></tr>
          {% endfor %}
        </table>
      </div>
      <div class="small">Gi√° tr·ªã sau m√£ ho√° cho b·∫£n ghi hi·ªán t·∫°i:</div>
      <div class="scroll-x">
        <table class="fixed">
          <tr>{% for fn in feature_names %}<th>{{ fn }}</th>{% endfor %}</tr>
          <tr>{% for fn in feature_names %}<td class="mono">{{ trace.encoded_row[fn] }}</td>{% endfor %}</tr>
        </table>
      </div>
    </details>

    <details open>
      <summary>3) Chu·∫©n ho√° MinMaxScaler</summary>
      <div class="small">C√¥ng th·ª©c: x_scaled = x * scale + min_offset (·ª©ng v·ªõi m·ªói thu·ªôc t√≠nh).</div>
      <div class="scroll-x">
        <table class="fixed">
          <tr>
            <th>Thu·ªôc t√≠nh</th><th>Min (train)</th><th>Max (train)</th><th>scale</th><th>min_offset</th>
          </tr>
          {% for fn in feature_names %}
          <tr>
            <td>{{ fn }}</td>
            <td class="mono">{{ "%.4f"|format(trace.scaler_info[fn].min) }}</td>
            <td class="mono">{{ "%.4f"|format(trace.scaler_info[fn].max) }}</td>
            <td class="mono">{{ "%.6f"|format(trace.scaler_info[fn].scale) }}</td>
            <td class="mono">{{ "%.6f"|format(trace.scaler_info[fn].min_offset) }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
      <div class="small">Vector sau chu·∫©n ho√° cho b·∫£n ghi hi·ªán t·∫°i:</div>
      <div class="scroll-x">
        <table class="fixed">
          <tr>{% for fn in feature_names %}<th>{{ fn }}</th>{% endfor %}</tr>
          <tr>{% for fn in feature_names %}<td class="mono">{{ "%.6f"|format(trace.scaled_row[fn]) }}</td>{% endfor %}</tr>
        </table>
      </div>
    </details>

    <details open>
      <summary>4) D·ª± ƒëo√°n m√¥ h√¨nh & Ng∆∞·ª°ng quy·∫øt ƒë·ªãnh</summary>
      <div class="small">Ng∆∞·ª°ng m·∫∑c ƒë·ªãnh: {{ trace.threshold }} (>= ng∆∞·ª°ng ‚Üí d·ª± ƒëo√°n "C√≥").</div>
      <div class="scroll-x">
        <table class="fixed">
          <tr><th>M√¥ h√¨nh</th><th>X√°c su·∫•t (p)</th><th>So v·ªõi ng∆∞·ª°ng</th><th>K·∫øt lu·∫≠n</th></tr>
          {% for model, (pred, prob) in results.items() %}
          <tr>
            <td>{{ model }}</td>
            <td class="mono">{{ "%.4f"|format(prob) }}</td>
            <td class="mono">{% if prob >= trace.threshold %}p ‚â• threshold{% else %}p &lt; threshold{% endif %}</td>
            <td>
              {% if pred==1 %}<span class="badge warn">C√≥</span>{% else %}<span class="badge ok">Kh√¥ng</span>{% endif %}
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </details>

  </div>
  {% endif %}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      console.log("Trang d·ª± ƒëo√°n Ti·ªÉu ƒë∆∞·ªùng ƒë√£ load (phi√™n b·∫£n c√≥ t∆∞·ªùng b∆∞·ªõc).");
    });
  </script>
</body>
</html>
